---
title: "Proyecto Actuariales"
author: "Arnoldo Bustos, Humberto Jimenez"
date: "18 de noviembre de 2018"
output: pdf_document
header-includes:
    -\usepackage[utf8]{inputenc}
    -\usepackage{amsmath,amssymb}
    -\usepackage{actuarialsymbol}
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

```{r}

# here = "C:/Users/Humberto/Downloads/Poyecto_Mate_Act_I-master"


library(lubridate)
library(lifecontingencies)
library(dplyr)
 
# Importa los datos brindados por la compañia 

here = "C:/Users/escan/OneDrive/Documentos/Grizzly/Matematica Actuarial I/Proyecto"

trabajadores <- readxl::read_excel(paste0(here, "/Datos_Proyecto_v2.xlsx"), sheet = "Trabajadores")

colnames(trabajadores) <- c("ID", "FEC_INGRESO", "SEXO", "FEC_NAC", "SALARIO")

mortalidad <- readxl::read_excel(paste0(here,"/Datos_Proyecto_v2.xlsx"), sheet = "Mortalidad", skip = 1 )

jubilados <- readxl::read_excel(paste0(here,"/Datos_Proyecto_v2.xlsx"), sheet = "Jubilados")

# Define la fecha a la que se realiza el estudio

hoy <-as.Date("2017-12-31")

# La inflación de largo plazo

inflacion = 0.04

# Tasa de crecimiento real de los salarios

tasa_crec_salarios_real = 0.02

# Tasa de crecimiento nominal de los salarios

tasa_crec_salarios_nom = ((1+inflacion)*(1+tasa_crec_salarios_real)) - 1

# Tasa de descuento real

tasa_desc_real = 0.03

# Tasa de interes real

tasa_interes_real =  (1/(1-tasa_desc_real)) - 1

# Tasa de interes nominal

tasa_interes_nominal = ((1+inflacion)*(1+tasa_interes_real)) - 1

# Cambia el formato de las fechas a objetos .Date

trabajadores <- dplyr::mutate(trabajadores, FEC_INGRESO = as.Date(FEC_INGRESO, format = "%d-%m-%y"))

trabajadores <- dplyr::mutate(trabajadores, FEC_NAC = as.Date(FEC_NAC,  format = "%d-%m-%y"))

# Calcula la fecha a partir de la cual puede pensionarse

trabajadores <- dplyr::mutate(trabajadores, FEC_PENSION = as.Date( paste0( as.character( as.numeric(format(FEC_NAC,"%Y")) + 65), format(FEC_NAC,"-%m-%d"))) )

k = which(as.numeric(is.na(trabajadores$FEC_PENSION)) == 1)

trabajadores$FEC_PENSION[k] = as.Date(paste0(as.character( as.numeric(format(trabajadores$FEC_NAC[k],"%Y")) + 65),"-02-28" ))

# Convierte los datos de mortalidad en un objeto tipo actuarialtable

tablaVidaH = probs2lifetable(mortalidad$Hombres, radix = 10000, type = "qx")
tablaActH = new("actuarialtable", i = tasa_interes_nominal, x = tablaVidaH@x, lx = tablaVidaH@lx)

tablaVidaM = probs2lifetable(mortalidad$Mujeres, radix = 10000, type = "qx")
tablaActM = new("actuarialtable", i = tasa_interes_nominal, x = tablaVidaM@x, lx = tablaVidaM@lx)

# Omega en la tabla de vida

w = getOmega(tablaActH)

# Factor de descuento nominal

v_nom = 1/(1 + tasa_interes_nominal)
  
trabajadores <- trabajadores %>%
  
# Calcula la antiguedad de los trabajadores
  
  mutate(ANTIGUEDAD = year(FEC_PENSION) + month(FEC_PENSION) / 12 + day(FEC_PENSION) / 365 - year(FEC_INGRESO) - month(FEC_INGRESO) /12 - day(FEC_INGRESO) / 365) %>% 
  
# Categoriza a los empleados según su antiguedad
  
  mutate( CATEG = ifelse(ANTIGUEDAD < 10, 1, ifelse(ANTIGUEDAD < 20, 2, ifelse(ANTIGUEDAD < 30, 3, 4)))) %>%

# Asigna a los empleados su porcentaje del salario según su antiguedad
  
  mutate( PORC_SAL_PENS = ifelse(ANTIGUEDAD < 10, 1, ifelse(ANTIGUEDAD < 20, 2, ifelse(ANTIGUEDAD < 30, 3, 4)))) %>%

# Asigna el número de salarios para el capital de retiro según su antiguedad
  
  mutate( NUM_SAL_CAP_RET = ifelse(ANTIGUEDAD < 10, 1, ifelse(ANTIGUEDAD < 20, 2, ifelse(ANTIGUEDAD < 30, 3, 4)))) %>%
  
  
# Calcula el salario sobre el cual se va a calcular la pensión.

  mutate( SALARIO_PENSION = SALARIO*(tasa_crec_salarios_nom) ^ (year(FEC_PENSION) - 2017)) %>% 
  
# Calcula el tiempo restante para que la persona se pensione  
  
  mutate( TIEMPO_PARA_PENSION = year(FEC_PENSION) - 2018 + ((month(FEC_PENSION)-1)/12 + day(FEC_PENSION)/365)) %>%
  
# Corrige el tiempor para pensión de los trabajadores que no se han pensionado
    
  mutate( TIEMPO_PARA_PENSION = ifelse(TIEMPO_PARA_PENSION  > 0, TIEMPO_PARA_PENSION, 0)) %>%
  
# Calcula la edad actural del trabajador
  
  mutate( EDAD = time_length(interval(FEC_NAC, hoy), unit = "year") ) %>%

# Calcula el factor de descuento de la fecha de pension  
  
  mutate( FACT_DESC_PEN = (v_nom ^ TIEMPO_PARA_PENSION) )

# Función que calcula la pensión para un trabajador

valor_Presente_Pension = function(x,sexo){
  
  if(sexo == "M"){
    tablaAct = tablaActH  
  }else{
    tablaAct = tablaActM
  }
  
  costo_Pension_Anual <- function(r){
    return( (12 * axn( tablaAct, x = x, n = 1, m = r, k = 12) + (tasa_interes_nominal/log(1 + tasa_interes_nominal)) * axn(tablaAct, x = x, m = r, k = 1, payment = "immediate")) * (1 + inflacion) ^ r)
  }
    return( sum( Vectorize(costo_Pension_Anual)(0:(w-(x))) ) )
}

val_Pres_Trab_Hom_No_Jub = valor_Presente_Pension(65, "M")

val_Pres_Trab_Muj_No_Jub = valor_Presente_Pension(65, "F")


valor_Presente_Pension_2 = function(x,sexo){
  if(x >= 65){
    return(valor_Presente_Pension(x,sexo))
  }else{
      if(sexo == "M"){
      return(val_Pres_Trab_Hom_No_Jub) 
    }else{
      return(val_Pres_Trab_Muj_No_Jub)
    }
  }
}

VP_SEG_FUN_65_HOM = Axn( tablaActH, x = 65, i = tablaActH@interest)

VP_SEG_FUN_65_MUJ = Axn( tablaActM, x = 65, i = tablaActM@interest)


valor_Presente_Seguro_Fun = function(x,sexo){
  if(x >= 65){
    if(sexo == "M"){
      return(Axn( tablaActH, x, i = tablaActH@interest))
    }else{
      return(Axn( tablaActM, x, i = tablaActM@interest))
    }
  }else{
    if(sexo == "M"){
      return(VP_SEG_FUN_65_HOM)
    }else{
      return(VP_SEG_FUN_65_MUJ)
    }
  }
}


  # Valor presente de una pensión de un hombre de 65 años

# Monto de seguro de gastos funerarios

seg_Fun = 1000000

trabajadores_MUJ <- trabajadores %>% filter(SEXO == "F") 
trabajadores_HOM <- trabajadores %>% filter(SEXO == "M") 

edad_trab_MUJ <- trabajadores_MUJ$EDAD
edad_trab_HOM <- trabajadores_HOM$EDAD

tiempo_para_pension_MUJ <- trabajadores_MUJ$TIEMPO_PARA_PENSION
tiempo_para_pension_HOM <- trabajadores_HOM$TIEMPO_PARA_PENSION

prob_65_Hom = pxt(tablaActH, x = edad_trab_HOM, t = tiempo_para_pension_HOM)
prob_65_Muj = pxt(tablaActM, x = edad_trab_MUJ, t = tiempo_para_pension_MUJ)

vP_PENSION_TRAB_HOM = Vectorize(valor_Presente_Pension_2)(edad_trab_HOM,  "M")
vP_PENSION_TRAB_MUJ = Vectorize(valor_Presente_Pension_2)(edad_trab_MUJ,  "F")

VP_SEG_FUN_HOM = seg_Fun * Vectorize(valor_Presente_Seguro_Fun)(edad_trab_HOM, "M")
VP_SEG_FUN_MUJ = seg_Fun * Vectorize(valor_Presente_Seguro_Fun)(edad_trab_MUJ, "F")

# Valor presente de la pensión 
trabajadores_HOM <- trabajadores_HOM %>% 
  mutate( VP_PENSION =  (v_nom ^ TIEMPO_PARA_PENSION) * prob_65_Hom * vP_PENSION_TRAB_HOM)

trabajadores_MUJ <- trabajadores_MUJ %>% 
  mutate( VP_PENSION =  (v_nom ^ TIEMPO_PARA_PENSION) * prob_65_Muj * vP_PENSION_TRAB_MUJ)

# Valor presente del capital de retiro  

trabajadores_MUJ <- trabajadores_MUJ %>% 
  mutate( VP_CAP_RET = (v_nom ^ TIEMPO_PARA_PENSION) * prob_65_Muj * SALARIO_PENSION ) 

trabajadores_HOM <- trabajadores_HOM %>% 
  mutate( VP_CAP_RET = (v_nom ^ TIEMPO_PARA_PENSION) * prob_65_Hom * SALARIO_PENSION ) 
# Valor presente y Valor Futuro del seguro de gastos funerarios
trabajadores_MUJ <- trabajadores_MUJ %>% 
  mutate( VP_SEG_FUN = (v_nom ^ TIEMPO_PARA_PENSION) * prob_65_Muj * VP_SEG_FUN_MUJ)

trabajadores_HOM <- trabajadores_HOM %>% 
  mutate( VP_SEG_FUN = (v_nom ^ TIEMPO_PARA_PENSION) * prob_65_Hom * VP_SEG_FUN_HOM)

costo_Plan_Trab = sum(trabajadores_MUJ$VP_PENSION, trabajadores_MUJ$VP_CAP_RET, trabajadores_MUJ$VP_SEG_FUN, trabajadores_HOM$VP_PENSION, trabajadores_HOM$VP_CAP_RET, trabajadores_HOM$VP_SEG_FUN)

```
